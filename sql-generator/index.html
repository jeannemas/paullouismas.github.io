<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>SQL Command Generator</title>

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">
		<link rel="stylesheet" href="/css/main.css">
		
		<script defer="true" src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
		<script defer="true" src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"></script>
		<!-- <script defer="true" src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script> -->
		<script src="./url-search-manager.js"></script>
	</head>
	<body x-data="{
			navbarOpen: false, 
			shareModalOpen: false, 
			$params: new URLSearchManager(location.search, true)
		}" x-bind:class="{ 'is-clipped': shareModalOpen }">
		<noscript>
			<section class="hero is-medium is-warning">
				<div class="hero-body">
					<div class="container">
						<h1 class="title">
							JavaScript required
						</h1>
						<h2 class="subtitle">
							Javascript is required to use this website.
						</h2>
					</div>
				</div>
			</section>
		</noscript>

		<nav class="navbar is-transparent" role="navigation" aria-label="main navigation">
			<div class="navbar-brand">
				<a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" @click="navbarOpen = !navbarOpen" :class="{ 'is-active': !!navbarOpen }">
					<span aria-hidden="true"></span>
					<span aria-hidden="true"></span>
					<span aria-hidden="true"></span>
				</a>
			</div>
		  
			<div class="navbar-menu" :class="{ 'is-active': !!navbarOpen }">
				<div class="navbar-start">
					<a href="/" class="navbar-item">
						Home
					</a>

					<div class="navbar-item has-dropdown is-hoverable">
						<a class="navbar-link">
							Tools
						</a>

						<div class="navbar-dropdown is-boxed">
							<a href="/sql-generator/" class="navbar-item">
								SQL Command Generator
							</a>
						</div>
					</div>
				</div>

				<div class="navbar-end"></div>
			</div>
		</nav>

		<section class="hero is-light is-medium">
			<div class="hero-body">
				<div class="container">
					<h1 class="is-1 title">
						SQL Commmand Generator
					</h1>

					<p>
						This generator allows to generate SQL insert statements from any CSV stored data.<br/>
						It allows columns manipulations as well as data skipping.
					</p>

					<p>
						<a href="./documentation/" class="button" type="button">
							<span>
								View the documentation
							</span>
							<span class="icon">
								<i class="fas fa-angle-double-right"></i>
							</span>
						</a>
					</p>
				</div>
			</div>
		</section>

		<section class="section">
			<div class="container">
				<div class="field">
					<div class="control">
						<label for="input_csv" class="label">
							CSV data
						</label>

						<textarea 
							class="textarea" 
							placeholder="Your CSV data goes here..." 
							id="input_csv" 
							spellcheck="false"
							x-html="$params.get('csv')"
							@input="$params.set('csv', $('#input_csv')[0].value)">
						</textarea>
					</div>
				</div>

				<div class="field">
					<div class="control">
						<label class="label">
							CSV headers
						</label>

						<label class="checkbox">
							<input 
								type="checkbox" 
								class="checkbox" 
								id="input_csvHasHeaders"
								x-bind:checked="$params.get('csvHasHeaders') === 'true'"
								@input="$params.set('csvHasHeaders', $('#input_csvHasHeaders')[0].checked)" />
							My CSV has headers.
						</label>

						<p class="help">
							Check if your CSV data has headers (this will ignore them while parsing the data).
						</p>
					</div>
				</div>

				<div class="field">
					<div class="control">
						<label for="input_separator" class="label">
							Separator
						</label>
						
						<div class="select">
							<select
								id="input_separator"
								x-bind:value="$params.get('separator')"
								@input="$params.set('separator', $('#input_separator')[0].value)">
								<option value=",">
									,
								</option>
								<option value=";">
									;
								</option>
							</select>
						</div>
					</div>
				</div>

				<div class="field">
					<div class="control">
						<label for="input_tableName" class="label">
							Table name
						</label>

						<input 
							type="text" 
							class="input" 
							id="input_tableName" 
							placeholder="Example" 
							spellcheck="false"
							x-bind:value="$params.get('tableName')"
							@input="$params.set('tableName', $('#input_tableName')[0].value)" />
					</div>
				</div>

				<div class="field">
					<div class="control">
						<label for="input_columnsName" class="label">
							Columns to insert to
						</label>

						<input 
							type="text" 
							class="input" 
							id="input_columnsName" 
							placeholder="column1,column2,column3" 
							spellcheck="false"
							x-bind:value="$params.get('columnsName')"
							@input="$params.set('columnsName', $('#input_columnsName')[0].value)" />

						<p class="help">
							Place the columns in order they need to be inserted.<br/>
							Separate the columns with a comma.
						</p>
					</div>
				</div>

				<div class="field">
					<div class="control">
						<label for="input_valuesFormat" class="label">
							Values command format
						</label>

						<textarea 
							id="input_valuesFormat" 
							class="textarea" 
							placeholder="('?1?', 'A string', ?2?, 42, ?3?, NULL)" 
							spellcheck="false"
							x-html="$params.get('valuesFormat')"
							@input="$params.set('valuesFormat', $('#input_valuesFormat')[0].value)">
						</textarea>

						<p class="help">
							Place placeholder value as: ?#?<br/>
							Where # is the position of the column in the CSV
						</p>
					</div>
				</div>

				<div class="field">
					<div class="control buttons">
						<button type="submit" class="button is-primary is-medium" id="button_generateSQL" @click.prevent="generateStatement()">Generate SQL</button>
						<!-- <button type="button" class="button is-light is-medium" id="button_clear" @click.prevent="clearFields(); $params.empty()">Clear fields</button> -->
						<!-- <button type="button" class="button is-info is-medium" id="button_share" title="Share this config" @click="shareModalOpen = true">Share</button> -->
					</div>

					<p class="help is-danger" id="errors"></p>
				</div>

				<div class="field">
					<div class="control">
						<label for="output_SQL">
							Generated SQL
						</label>

						<textarea class="textarea" id="output_SQL" readonly placeholder="Your generated SQL will appear here." spellcheck="false"></textarea>

						<p class="help">
							Always verify the generated SQL before using it in production!
						</p>
					</div>
				</div>

				<!-- <div class="modal" :class="{ 'is-active': !!shareModalOpen }">
					<div class="modal-background" @click="shareModalOpen = false"></div>

					<div class="modal-content">
						<div class="box">
							<textarea class="textarea" x-text="location.href" readonly spellcheck="false"></textarea>

							<button class="button is-light copy" :data-clipboard-text="location.href">Copy to clipboard</button>
						</div>
					</div>

					<button class="modal-close is-large" aria-label="close" @click="shareModalOpen = false"></button>
				</div> -->
			</div>
		</section>

		<footer class="footer">
			<p class="content has-text-centered">
				<a href="https://bulma.io" target="_blank" class="no-anchor">
					<img src="https://bulma.io/images/made-with-bulma.png" alt="Made with Bulma" width="128" height="24">
				</a>

				<br/>

				by
				
				<a href="//instagram.com/paullouis.mas/" target="_blank">
					Paul-Louis Mas
				</a>
			</p>
		</footer>

		<script type="text/javascript" src="./csv-tool.js"></script>

		<script>
			const $ = (...selectors) => 
				selectors.reduce((accumulator, value) => 
					accumulator.concat(document.querySelector(value)), []);

			const $elements = $("#input_csv", "#input_csvHasHeaders", "#input_separator", "#input_tableName", "#input_columnsName", "#input_valuesFormat");
			const [ $csv, $csvHasHeaders, $separator, $tableName, $columnsName, $valuesFormat ] = $elements;
			const $output = $("#output_SQL")[0];

			function clearFields() {
				$csv.value = "";
				$csvHasHeaders.checked = false;
				$separator.selectedIndex = 0;
				$tableName.value = "";
				$columnsName.value = "";
				$valuesFormat.value = "";
				$output.value = "";
			}

			function generateStatement() {
				const errors = [];

				if ($csv.value === "") {
					errors.push(`Your CSV data is empty.`);
				}
				if ($tableName.value === "") {
					errors.push(`You must specify the name of the table to insert into.`);
				}
				if ($columnsName.value === "" && !$csvHasHeaders.checked) {
					errors.push(`You must specify the columns to insert to.`);
				}
				if ($valuesFormat.value === "") {
					errors.push(`You must specify the format of the insert values.`);
				}

				if (errors.length > 0) {
					document.getElementById("errors").innerText = errors.join("\n");

					return;
				}

				const $manager = new CsvManager($csv.value, $separator.value, $csvHasHeaders.checked);

				let code = `INSERT INTO [${$tableName.value}] (${($csvHasHeaders.checked && $columnsName.value === "" ? $manager.getHeaders().join(", ") : $columnsName.value).trim().split(",").map(column => column.trim()).join(", ")}) VALUES \n`;

				$manager.removeHeaders();
					
				const $entry = $manager.entries();
				const $values = [];

				let entry;

				do {
					entry = $entry.value;

					let value = $valuesFormat.value.replace(/\/\/.{0,}$/gm, "");

					for (let iterator = 1; iterator <= entry.length; iterator += 1) {
						value = value.replace(new RegExp(`\\?${iterator}\\?`, "g"), entry[iterator - 1] || "NULL");
					}

					$values.push(value.trim());

					$entry.next();
				} while ($entry.done !== true);

				code = `${code}${$values.join(", \n")}`;

				return $output.value = code;
			}

			window.addEventListener("load", () => {
				/* new ClipboardJS(".copy"); */
			});
		</script>

		<script type="module" src="/ga.js"></script>
	</body>
</html>